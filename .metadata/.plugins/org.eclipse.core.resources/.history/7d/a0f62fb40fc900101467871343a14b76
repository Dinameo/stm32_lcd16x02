#include "main.h"
#include "mpu6050.h"





uint8_t MPU6050_Init(MPU6050_t* mpu6050)
{
	HAL_Delay(100); // On dinh sau khi cap nguon
	uint8_t check;
	if(HAL_I2C_Mem_Read(mpu6050->i2c, mpu6050->addr, MPU6050_WHO_AM_I, 1, &check, 1, MPU6050_TIME_OUT) == HAL_OK)
	{
		uint8_t data = 0x01;	// Thoat sleep (Bit 6 = 0), chọn PLL voi X-axis Gryo làm nguồn clock (CLKSEL = 001)
		HAL_I2C_Mem_Write(mpu6050->i2c, mpu6050->addr, MPU6050_PWR_MGMT_1, 1, &data, 1, MPU6050_TIME_OUT);

		data = 0x07;	// Set sample rate = 1kHz/(7+1) = 125Hz
		HAL_I2C_Mem_Write(mpu6050->i2c, mpu6050->addr, MPU6050_SMPLRT_DIV, 1, &data, 1,  MPU6050_TIME_OUT);
		HAL_Delay(100); // PLL lock

		data = 0x00;	// Full scale range cua con quay hoi chuyen (Gyroscope) +-250o/s
		HAL_I2C_Mem_Write(mpu6050->i2c, mpu6050->addr, MPU6050_GYRO_CONFIG, 1, &data, 1,  MPU6050_TIME_OUT);

		data = 0x00;	// Full scale range cua gia toc ke (Accelerometer) +-2g
		HAL_I2C_Mem_Write(mpu6050->i2c, mpu6050->addr, MPU6050_ACCEL_CONFIG, 1, &data, 1,  MPU6050_TIME_OUT);

		data = 0x01;	// Digital Low Pass Filter: Bandwidth 184 (Acc), 188 (Gyro); delay 2ms (Acc), 1ms (Gyro)
		HAL_I2C_Mem_Write(mpu6050->i2c, mpu6050->addr, MPU6050_CONFIG, 1, &data, 1,  MPU6050_TIME_OUT);

		mpu6050->data_raw.accel_x = 0;
		mpu6050->data_raw.accel_y = 0;
		mpu6050->data_raw.accel_z = 0;
		mpu6050->data_raw.gyro_x = 0;
		mpu6050->data_raw.gyro_y = 0;
		mpu6050->data_raw.gyro_z = 0;
		mpu6050->data_raw.temp = 0;

		mpu6050->data.accel_x = 0;
		mpu6050->data.accel_y = 0;
		mpu6050->data.accel_z = 0;
		mpu6050->data.gyro_x = 0;
		mpu6050->data.gyro_y = 0;
		mpu6050->data.gyro_z = 0;
		mpu6050->data.temp = 0;
	}

	return 0;
}
int16_t MPU6050_Cvt_Int16(uint8_t high_byte, uint8_t low_byte) {return (int16_t) ((high_byte << 8) | low_byte);}
void MPU6050_Read_Accel(MPU6050_t* mpu6050)
{
	uint8_t accel_data[MPU6050_ACCEL_SIZE] = {0};
	if(HAL_I2C_Mem_Read(mpu6050->i2c, mpu6050->addr, MPU6050_ACCEL_BASE, 1, accel_data, MPU6050_ACCEL_SIZE, MPU6050_TIME_OUT) == HAL_OK)
	{
		mpu6050->data_raw.accel_x = MPU6050_Cvt_Int16(accel_data[0], accel_data[1]);
		mpu6050->data_raw.accel_y = MPU6050_Cvt_Int16(accel_data[2], accel_data[3]);
		mpu6050->data_raw.accel_z = MPU6050_Cvt_Int16(accel_data[4], accel_data[5]);
	}
}
void MPU6050_Read_Gyro(MPU6050_t* mpu6050)
{
	uint8_t gyro_data[MPU6050_GYRO_SIZE] = {0};
	if(HAL_I2C_Mem_Read(mpu6050->i2c, mpu6050->addr, MPU6050_GYRO_BASE, 1, gyro_data, MPU6050_GYRO_SIZE, MPU6050_TIME_OUT) == HAL_OK)
	{
		mpu6050->data_raw.gyro_x = MPU6050_Cvt_Int16(gyro_data[0], gyro_data[1]);
		mpu6050->data_raw.gyro_y = MPU6050_Cvt_Int16(gyro_data[2], gyro_data[3]);
		mpu6050->data_raw.gyro_z = MPU6050_Cvt_Int16(gyro_data[4], gyro_data[5]);
	}
}
void MPU6050_Read_Temp(MPU6050_t* mpu6050)
{
	uint8_t temp_data[MPU6050_TEMP_SIZE] = {0};
	if(HAL_I2C_Mem_Read(mpu6050->i2c, mpu6050->addr, MPU6050_TEMP_BASE, 1, temp_data, MPU6050_TEMP_SIZE, MPU6050_TIME_OUT) == HAL_OK)
	{
		mpu6050->data_raw.temp = MPU6050_Cvt_Int16(temp_data[0], temp_data[1]);
	}
}
void MPU6050_Read_All(MPU6050_t* mpu6050)
{
	uint8_t data[MPU6050_ALL_SIZE] = {0};
	if(HAL_I2C_Mem_Read(mpu6050->i2c, mpu6050->addr, MPU6050_ACCEL_BASE, 1, data, MPU6050_ALL_SIZE, MPU6050_TIME_OUT) == HAL_OK)
	{
		mpu6050->data_raw.accel_x_raw = MPU6050_Cvt_Int16(data[0], data[1]);
		mpu6050->data_raw.accel_y_raw = MPU6050_Cvt_Int16(data[2], data[3]);
		mpu6050->data_raw.accel_z_raw = MPU6050_Cvt_Int16(data[4], data[5]);

		mpu6050->data_raw.temp = MPU6050_Cvt_Int16(data[6], data[7]);

		mpu6050->data_raw.gyro_x = MPU6050_Cvt_Int16(data[8], data[9]);
		mpu6050->data_raw.gyro_y = MPU6050_Cvt_Int16(data[10], data[11]);
		mpu6050->data_raw.gyro_z = MPU6050_Cvt_Int16(data[12], data[13]);
	}
}
